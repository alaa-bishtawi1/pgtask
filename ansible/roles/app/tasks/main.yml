---

- set_fact:
    new_database_url: "postgresql://{{postgres_user}}:{{postgres_password}}@{{postgres_db_host}}/{{postgres_db}}"


- name: Update package lists
  apt:
    update_cache: yes
  become: yes

- name: Install necessary dependencies
  apt:
    name: "{{ item }}"
    state: present
  loop:
    - git
    - python3

- name: Install python3-pip separately
  apt:
    name: python3-pip
    state: present
  become: yes


- name: Clone the application repository
  git:
    repo: '{{ app_repo }}'
    dest: '{{ app_dest }}'
  register: git_clone_result
  ignore_errors: yes

- name: Check if Git clone was successful
  fail:
    msg: "Git clone failed. Please check the repository URL or the permissions."
  when: git_clone_result is failed



- name: Update database URL in app.py
  lineinfile:
    path: /opt/app/app.py
    regexp: '^DATABASE_URL ='
    line: "DATABASE_URL = '{{ new_database_url }}'"
  become: yes

- name: Install Flask and psycopg2-binary
  pip:
    name: "{{ item }}"
    executable: pip3
  loop:
    - flask
    - psycopg2-binary


- name: Start the application in the background
  shell: nohup python3 /opt/app/app.py  > /opt/app/app.log 2>&1 &
  args:
    executable: /bin/bash
    chdir: /opt/app
  async: 10
  poll: 0
  become: yes

